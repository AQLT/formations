{
  "hash": "065df931e88967074dafef863e41db19",
  "result": {
    "markdown": "---\ntitle: \"4 - Qualité de la décomposition sous R\"\nsubtitle: |\n  Formation - Désaisonnalisation avec JDemetra+ et RJDemetra\n  ![](img/logo.png){width=1in}\nauthor: \"Alain Quartier-la-Tente\"\nformat: html\nlang: fr\nlanguage:\n title-block-author-single: Auteur\n---\n\n\n\n\n\n> L'objectif de ce TP est d'apprendre à étudier la qualité de la décomposition depuis RJDemetra\n\nSi besoin, ci-dessous un exemple de code pour récupérer vos données :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfichier <- \"../data/data_rte.xlsx\"\n# # Ou en téléchargeant le fichier depuis internet :\n# fichier <- tempfile(fileext = \"xlsx\")\n# url <- \"https://aqlt.github.io/formations/2021/rte/data/data_rte.xlsx\"\n# download.file(url, fichier)\ndata_rte <- readxl::read_excel(fichier)\ndate_deb <- 2006\ndata_rte <- ts(data_rte[,-1], start = date_deb,\n               frequency = 12)\n```\n:::\n\n\nPrenons une spécification par défaut :\n\n\n\n\n\nDans ce TP nous allons voir différentes façon de vérifier la qualité de la décomposition.\nTout d'abord, on peut commencer par regarder les statistiques m dont les définitions sont rappelées ci-dessous\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> Poids </th>\n   <th style=\"text-align:left;\"> Description </th>\n   <th style=\"text-align:left;\"> Si problème   </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> M1 </td>\n   <td style=\"text-align:center;\"> 10 </td>\n   <td style=\"text-align:left;\"> Contribution de l'irrégulier à la variance totale (stationnarisation par différence d'ordre 3). Si trop élevé, difficile d'extraire la saisonnalité. </td>\n   <td style=\"text-align:left;\"> Points atypiques ou taille des filtres </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M2 </td>\n   <td style=\"text-align:center;\"> 11 </td>\n   <td style=\"text-align:left;\"> Contribution de l'irrégulier à la variance totale (stationnarisation par une droite). </td>\n   <td style=\"text-align:left;\"> Points atypiques ou taille des filtres </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M3 </td>\n   <td style=\"text-align:center;\"> 10 </td>\n   <td style=\"text-align:left;\"> Mesuré à partir du ratio I/C. Si trop grand on aura du mal à séparer les deux composantes. </td>\n   <td style=\"text-align:left;\"> Points atypiques ou taille des filtres </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M4 </td>\n   <td style=\"text-align:center;\"> 8 </td>\n   <td style=\"text-align:left;\"> Test autocorrélation sur l'irrégulier (réduire le filtre saisonnier). </td>\n   <td style=\"text-align:left;\"> Filtre saisonnier plus court </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M5 </td>\n   <td style=\"text-align:center;\"> 11 </td>\n   <td style=\"text-align:left;\"> Mesuré à partir du MCD (nombre de mois nécessaires pour que les variations absolues de la TC l'emporte sur I). </td>\n   <td style=\"text-align:left;\"> Points atypiques </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M6 </td>\n   <td style=\"text-align:center;\"> 10 </td>\n   <td style=\"text-align:left;\"> Vérifie si la moyenne mobile M3x5 est appropriée ($1.5 < I/S < 6.5$). </td>\n   <td style=\"text-align:left;\"> Prendre filtre plus long </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M7 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n   <td style=\"text-align:left;\"> Permet de voir si la saisonnalité est identifiable (compare part relative de la saisonnalité stable et mobile). </td>\n   <td style=\"text-align:left;\"> Schéma multiplicatif ? </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M8 </td>\n   <td style=\"text-align:center;\"> 7 </td>\n   <td style=\"text-align:left;\"> Mesure l'évolution de la S de court terme. </td>\n   <td style=\"text-align:left;\"> Changer filtre saisonnier </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M9 </td>\n   <td style=\"text-align:center;\"> 7 </td>\n   <td style=\"text-align:left;\"> Mesure l'évolution de la S de long terme. </td>\n   <td style=\"text-align:left;\"> Changer filtre saisonnier </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M10 </td>\n   <td style=\"text-align:center;\"> 4 </td>\n   <td style=\"text-align:left;\"> M8 sur dernières années ($N-2$ à $N-5$). </td>\n   <td style=\"text-align:left;\"> Changer filtre saisonnier </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> M11 </td>\n   <td style=\"text-align:center;\"> 4 </td>\n   <td style=\"text-align:left;\"> M9 sur dernières années ($N-2$ à $N-5$). </td>\n   <td style=\"text-align:left;\"> Changer filtre saisonnier </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nÀ partir d'un objet `\"X13\"`, les statistiques m disponibles dans la sous-liste `.$decomposition` :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa$decomposition\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n Monitoring and Quality Assessment Statistics:  \n      M stats\nM(1)    0.163\nM(2)    0.089\nM(3)    1.181\nM(4)    0.558\nM(5)    1.020\nM(6)    0.090\nM(7)    0.083\nM(8)    0.244\nM(9)    0.062\nM(10)   0.272\nM(11)   0.256\nQ       0.368\nQ-M2    0.402\n\nFinal filters: \nSeasonal filter:  3x5\nTrend filter:  13 terms Henderson moving average\n```\n:::\n:::\n\n\n::: callout-note\n## Exercice\nQue signifie ces valeurs des statistiques m plus grandes que 1 ? Est-ce important ? Si oui comment les corriger ?\n:::\n\n::: {.callout-caution collapse=\"true\"}\n## Indice\nQue pensez-vous de la tendance (`plot(mysa$final, type_chart = \"sa-trend\")`) ? Quelle est la contribution du cycle à la variance totale (`mysa$diagnostics$variance_decomposition`) ? \n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\nLa tendance est plutôt plate et la contribution du cycle à la variance totale est petite, on peut donc ignorer la statistique m3. \nLa statistique M5 suggère de prendre un filtre saisonnier plus long, par exemple en utilisant le code suivant :\n\n`mysa2 <- x13(get_ts(mysa), x13_spec(mysa, x11.seasonalma = \"S3X9\"))`\n\nMais en faisant cela on crée de la saisonnalité résiduelle ! (`mysa2$diagnostics`), c'est donc mieux de rester sur les paramètres par défaut.\n:::\n\nAlors que pour changer le filtre saisonnier il suffit d'utiliser le paramètre `x11.seasonalma`, pour changer la longueur du filtre de Henderson il faut désactiver l'option de recherche automatique de la longueur du filtre (`x11.trendAuto = FALSE`) et spécifier la longueur dans le paramètre `x11.trendma`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_spec <- x13_spec(mysa, x11.trendma = 15)\nnew_spec$x11# Colonne trendma inchangée !\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            x11.mode x11.seasonalComp x11.lsigma x11.usigma x11.trendAuto\nPredefined Undefined             TRUE        1.5        2.5          TRUE\nUser_modif      <NA>               NA         NA         NA            NA\nFinal      Undefined             TRUE        1.5        2.5          TRUE\n           x11.trendma x11.seasonalma x11.fcasts x11.bcasts x11.calendarSigma\nPredefined          13            Msr         -1          0              None\nUser_modif          15           <NA>         NA         NA              <NA>\nFinal               13            Msr         -1          0              None\n           x11.sigmaVector x11.excludeFcasts\nPredefined              NA             FALSE\nUser_modif              NA                NA\nFinal                   NA             FALSE\n```\n:::\n\n```{.r .cell-code}\nnew_spec <- x13_spec(mysa, x11.trendma = 15, x11.trendAuto = FALSE)\nnew_spec$x11\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            x11.mode x11.seasonalComp x11.lsigma x11.usigma x11.trendAuto\nPredefined Undefined             TRUE        1.5        2.5          TRUE\nUser_modif      <NA>               NA         NA         NA         FALSE\nFinal      Undefined             TRUE        1.5        2.5         FALSE\n           x11.trendma x11.seasonalma x11.fcasts x11.bcasts x11.calendarSigma\nPredefined          13            Msr         -1          0              None\nUser_modif          15           <NA>         NA         NA              <NA>\nFinal               15            Msr         -1          0              None\n           x11.sigmaVector x11.excludeFcasts\nPredefined              NA             FALSE\nUser_modif              NA                NA\nFinal                   NA             FALSE\n```\n:::\n:::\n\n\nSur la qualité de la décomposition, la sous liste `.$diagnostics` contient les contributions des différentes composantes à la variance de la série, le test combiné et les tests sur la saisonnalité et jours ouvrables résiduels :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa$diagnostics\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n Relative contribution of the components to the stationary\n portion of the variance in the original series,\n after the removal of the long term trend \n Trend computed by Hodrick-Prescott filter (cycle length = 8.0 years)\n           Component\n Cycle         2.251\n Seasonal     59.750\n Irregular     1.067\n TD & Hol.     2.610\n Others       33.718\n Total        99.395\n\n Combined test in the entire series \n Non parametric tests for stable seasonality\n                                                          P.value\n   Kruskall-Wallis test                                      0.000\n   Test for the presence of seasonality assuming stability   0.000\n   Evolutive seasonality test                                0.034\n \n Identifiable seasonality present\n\n Residual seasonality tests \n                                      P.value\n qs test on sa                          0.985\n qs test on i                           0.865\n f-test on sa (seasonal dummies)        0.958\n f-test on i (seasonal dummies)         0.893\n Residual seasonality (entire series)   0.876\n Residual seasonality (last 3 years)    0.906\n f-test on sa (td)                      0.987\n f-test on i (td)                       0.993\n```\n:::\n:::\n\n\nCes tests sont effectués sur l'ensemble de la série, alors que dans le main result le f-test est effectué sur les 8 dernières années.\nIl n'est pour l'instant pas possible d'exporter les tests de saisonnalité résiduelle sur les 8 ou 10 dernières années.\nÀ partir du packages `rjd3sa` il est en revanche possible de calculer la tous les tests à l'exception du f-test.\n\nPar rapport aux éléments vus en cours, les msr par mois sont exportables en utilisant le paramètre `userdefined` de `x13`.\nIl y a cependant actuellement un bug qui ne permet pas de l'exporter pour le dernier mois :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmysa <- x13(ipi_fr, \n            userdefined = c(\"diagnostics.msr-global\",\n                            sprintf(\"diagnostics.msr(%i)\", 1:12)))\nc(mysa$user_defined)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$`diagnostics.msr-global`\n[1] 4.224309\n\n$`diagnostics.msr(1)`\n[1] 6.918248\n\n$`diagnostics.msr(2)`\n[1] 4.679206\n\n$`diagnostics.msr(3)`\n[1] 4.351482\n\n$`diagnostics.msr(4)`\n[1] 5.808313\n\n$`diagnostics.msr(5)`\n[1] 4.446801\n\n$`diagnostics.msr(6)`\n[1] 3.175827\n\n$`diagnostics.msr(7)`\n[1] 5.102764\n\n$`diagnostics.msr(8)`\n[1] 2.756466\n\n$`diagnostics.msr(9)`\n[1] 4.216562\n\n$`diagnostics.msr(10)`\n[1] 4.750469\n\n$`diagnostics.msr(11)`\n[1] 5.088831\n\n$`diagnostics.msr(12)`\nNULL\n```\n:::\n:::\n\n\nPour extraire tous les MSR, préférer la solution suivante :\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextract_msr <- function(x, i = 1:12){\n    jmodel <- suppressWarnings(jx13(get_ts(x), x13_spec(x)))\n    jres <- jmodel$result@internal$getResults()\n    jres <- new(Class = \"X13_java\", internal = jres)\n    res <- sapply(i, function(i_){\n        RJDemetra:::result(jres,\n                           sprintf(\"msr(%i)\", i_))\n    })\n    names(res) <- sprintf(\"msr(%i)\", i)\n    res\n}\nextract_msr(mysa)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  msr(1)   msr(2)   msr(3)   msr(4)   msr(5)   msr(6)   msr(7)   msr(8) \n6.918248 4.679206 4.351482 5.808313 4.446801 3.175827 5.102764 2.756466 \n  msr(9)  msr(10)  msr(11)  msr(12) \n4.216562 4.750469 5.088831 2.953120 \n```\n:::\n:::\n",
    "supporting": [
      "R-4-X11_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}